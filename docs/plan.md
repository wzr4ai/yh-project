# çƒŸèŠ±çˆ†ç«¹åå°ç®¡ç†ç³»ç»Ÿå¼€å‘è§„åˆ’ (æœ€ç»ˆæ‰§è¡Œç‰ˆ)

## ğŸš€ ä¸€ã€é¡¹ç›®æŠ€æœ¯æ ˆä¸æ¶æ„

* **å‰ç«¯:** Uniapp (å‘å¸ƒç›®æ ‡: **å¾®ä¿¡å°ç¨‹åº**)
* **åç«¯:** FastAPI (Python)
* **æ•°æ®åº“:** PostgreSQL
* **åŒ…ç®¡ç†:** uv
* **å®¹å™¨åŒ–:** Docker + Docker Compose
* **ç½‘å…³/å®‰å…¨:** **Nginx** (å¿…é¡»ï¼Œç”¨äºåå‘ä»£ç†å’Œ **SSL è¯ä¹¦**é…ç½®ï¼Œæ»¡è¶³å°ç¨‹åº HTTPS è¦æ±‚)
* **æƒé™æ¨¡å‹:** è½»é‡ RBACï¼Œä»…æœ‰ **è€æ¿**ã€**åº—å‘˜** ä¸¤ä¸ªè§’è‰²ã€‚è€æ¿å…¨é‡å¯è§/å¯æ“ä½œï¼›åº—å‘˜ä»…å¯è§é”€å”®ä»·æ ¼ä¸é”€å”®ç›¸å…³åŠŸèƒ½ï¼Œä¸å¯è§æˆæœ¬ã€æ¯›åˆ©ã€é‡‡è´­é‡‘é¢ç­‰æ•æ„Ÿæ•°æ®ã€‚

## ğŸ§  äºŒã€æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (ç²¾ç»†åŒ–)

### 1. ä»·æ ¼ä½“ç³» (ä¼˜å…ˆçº§: ä¾‹å¤– > åˆ†ç±» > å…¨å±€)
ç³»ç»Ÿåœ¨è®¡ç®—å•†å“çš„**â€œæ ‡å‡†é›¶å”®ä»·â€**æ—¶ï¼Œéµå¾ªä»¥ä¸‹é€»è¾‘ï¼š
1.  **ç¬¬ä¸€ä¼˜å…ˆçº§ (ä¾‹å¤–):** æ£€æŸ¥å•†å“æ˜¯å¦è®¾ç½®äº† `fixed_retail_price` (å›ºå®šé›¶å”®ä»·)ã€‚å¦‚æœæœ‰ï¼Œç›´æ¥ä½¿ç”¨ã€‚
2.  **ç¬¬äºŒä¼˜å…ˆçº§ (åˆ†ç±»):** æ£€æŸ¥å•†å“æ‰€å±åˆ†ç±»æ˜¯å¦è®¾ç½®äº† `category_multiplier`ã€‚å¦‚æœæœ‰ï¼Œæ ‡å‡†é›¶å”®ä»· = `base_cost` * `category_multiplier`ã€‚
3.  **ç¬¬ä¸‰ä¼˜å…ˆçº§ (å…¨å±€):** ä½¿ç”¨ç³»ç»Ÿå…¨å±€é…ç½®çš„ `global_multiplier`ã€‚æ ‡å‡†é›¶å”®ä»· = `base_cost` * `global_multiplier`ã€‚

### 2. è§’è‰²ä¸æƒé™åŸåˆ™
* **è€æ¿:** å¯è®¿é—®å…¨éƒ¨æ¨¡å—ä¸æ•°æ® (é‡‡è´­ã€åº“å­˜ã€æˆæœ¬ã€æ¯›åˆ©ã€æŠ¥è¡¨ã€é…ç½®)ã€‚
* **åº—å‘˜:** ä»…èƒ½æ‰§è¡Œé”€å”®å½•å…¥ã€æŸ¥çœ‹å¯å”®å•†å“åŠå…¶æ ‡å‡†é›¶å”®ä»·/å®é™…æˆäº¤ä»·ã€æ‰§è¡Œåº“å­˜æ‰£å‡ï¼›ä¸å¯æŸ¥çœ‹æˆæœ¬ã€è¿›ä»·ã€æ¯›åˆ©ã€åº“å­˜è´§å€¼ã€é‡‡è´­å•é‡‘é¢ã€‚
* **æ•°æ®éš”ç¦»:** API å±‚æŒ‰è§’è‰²è£å‰ªå­—æ®µï¼›å‰ç«¯è·¯ç”±ä¸ç»„ä»¶å±‚éšè—æ•æ„Ÿå…¥å£ã€‚

### 3. æ•°æ®å¯¼å…¥ (å•†å“å½•å…¥)
* æ”¯æŒ **CSV/Excel** æ‰¹é‡å¯¼å…¥å•†å“ã€åˆ†ç±»æ˜ å°„å’Œåˆ«åã€‚
* æä¾›å¯¼å…¥æ¨¡æ¿ä¸å­—æ®µæ ¡éªŒï¼Œé”™è¯¯è¡Œéœ€è¿”å›å…·ä½“åŸå› å¹¶å¯ä¸‹è½½é”™è¯¯è¡Œã€‚
* å•ä»“èµ·æ­¥ï¼Œä½†è¡¨ç»“æ„ä¿ç•™ `warehouse_id` æ‰©å±•ç©ºé—´ (å½“å‰å›ºå®šé»˜è®¤ä»“)ã€‚

### 4. é‡‡è´­ä¸åˆ°è´§
* **é‡‡è´­å•** åˆ›å»ºåä¸ç«‹åˆ»å½±å“åº“å­˜ï¼›åˆ°è´§ç¡®è®¤åæ‰å…¥åº“ã€‚
* åˆ°è´§æ—¶å†™å…¥ `inventory` ä¸ `inventory_log`ï¼Œå¹¶å°†è¿›ä»·å†™å…¥é‡‡è´­æ˜ç»†ï¼Œä¾¿äºå®¡è®¡ã€‚
* é‡‡è´­å•çŠ¶æ€ï¼šè‰ç¨¿ -> å¾…åˆ°è´§ -> éƒ¨åˆ†åˆ°è´§ -> å®Œæˆ -> å…³é—­ã€‚

### 5. è´¢åŠ¡ä¸é”€å”®åˆ†æé€»è¾‘
* **è¿›ä»·æ¨¡å¼ (2A):** åˆ©æ¶¦è®¡ç®—åŸºäºå•†å“å½“å‰çš„ `base_cost_price` (ä¸è¿›è¡Œå¤æ‚çš„åŠ æƒå¹³å‡ï¼Œä¾é äººå·¥æ›´æ–°è¿›ä»·)ã€‚
* **é”€å”®å¿«ç…§:** ä¸ºäº†ä¿è¯å†å²æ•°æ®çš„å‡†ç¡®æ€§ï¼Œé”€å”®æˆäº¤çš„ä¸€ç¬é—´ï¼Œå¿…é¡»å°†å½“æ—¶çš„ **è¿›ä»·** å’Œ **è®¡ç®—å‡ºçš„æ ‡å‡†é›¶å”®ä»·** å†™å…¥é”€å”®æ˜ç»†è¡¨ (`sales_item`)ï¼Œé˜²æ­¢æœªæ¥æ”¹ä»·å½±å“å†å²æŠ¥è¡¨ã€‚
* **æ ¸å¿ƒæŒ‡æ ‡è®¡ç®—:**
    * **åº“å­˜æ½œåœ¨è´§å€¼:** $\sum (\text{å½“å‰åº“å­˜} \times \text{æ ‡å‡†é›¶å”®ä»·})$
    * **å®é™…é”€å”®é¢:** $\sum \text{å®é™…æˆäº¤ä»·}$
    * **æœŸæœ›é”€å”®é¢:** $\sum \text{æ ‡å‡†é›¶å”®ä»· (å¿«ç…§)}$
    * **æº¢ä»·/æŠ˜ä»·å·®å€¼:** $\text{å®é™…é”€å”®é¢} - \text{æœŸæœ›é”€å”®é¢}$ (æ­£æ•°ä»£è¡¨å¤šå–äº†ï¼Œè´Ÿæ•°ä»£è¡¨æ‰“æŠ˜äº†)
    * **å®é™…æ¯›åˆ©:** $\text{å®é™…é”€å”®é¢} - \sum (\text{è¿›ä»·} \times \text{æ•°é‡})$

## ğŸ› ï¸ ä¸‰ã€æ•°æ®åº“è®¾è®¡ (PostgreSQL æœ€ç»ˆç‰ˆ)

### 1. é…ç½®ä¸åŸºç¡€è¡¨
| è¡¨å | å­—æ®µ (å…³é”®) | æè¿° |
| :--- | :--- | :--- |
| `system_config` | `key` (PK), `value` | å­˜å‚¨ `global_retail_multiplier` (å…¨å±€ç³»æ•°)ã€‚ |
| `category` | `id`, `name`, **`retail_multiplier` (Nullable)** | åˆ†ç±»ä¿¡æ¯åŠåˆ†ç±»ç³»æ•°ã€‚ |
| `product` | `id`, `name`, `category_id`, `spec`, `base_cost_price`, **`fixed_retail_price` (Nullable)**, `img_url` | å•†å“ä¸»è¡¨ã€‚`fixed_retail_price` ä¸ä¸ºç©ºå³ä¸ºâ€œä¾‹å¤–ä»·æ ¼â€ã€‚ |
| `product_alias` | `id`, `product_id`, `alias_name` | å•†å“åˆ«åï¼Œè¾…åŠ©æœç´¢ã€‚ |
| `user` | `id`, `username`, `password_hash`, `role` (`owner`/`clerk`) | åŸºç¡€è´¦å·è¡¨ã€‚ |
| `warehouse` (é¢„ç•™) | `id`, `name` | å•ä»“æ¨¡å¼ä¸‹å›ºå®šä¸€æ¡é»˜è®¤ä»“è®°å½•ï¼Œä¾¿äºæœªæ¥æ‰©å±•å¤šä»“ã€‚ |

### 2. ä¸šåŠ¡è®°å½•è¡¨
| è¡¨å | å­—æ®µ (å…³é”®) | æè¿° |
| :--- | :--- | :--- |
| `inventory` | `product_id`, `warehouse_id`, `current_stock` | å®æ—¶åº“å­˜ã€‚ |
| `inventory_log` | `id`, `product_id`, `warehouse_id`, `change_date`, `change_qty`, `type`, `ref_type`, `ref_id` | æ¯æ—¥åº“å­˜å˜åŠ¨æ—¥å¿— (å…¥åº“/å‡ºåº“/ç›˜ç‚¹/é‡‡è´­åˆ°è´§/é”€å”®)ã€‚ |
| `purchase_order` | `id`, `status`, `supplier`, `expected_date`, `created_by`, `remark` | é‡‡è´­å•ä¸»è¡¨ã€‚ |
| `purchase_item` | `id`, `purchase_order_id`, `product_id`, `quantity`, `expected_cost`, `received_qty`, `actual_cost` | é‡‡è´­æ˜ç»†ï¼Œæ”¯æŒéƒ¨åˆ†åˆ°è´§ã€‚ |
| `inventory_import_job` | `id`, `file_name`, `status`, `total_rows`, `success_rows`, `error_rows`, `error_report_url`, `created_by` | CSV/Excel å¯¼å…¥ä»»åŠ¡è®°å½•ã€‚ |
| `sales_order` | `id`, `order_date`, `total_actual_amount`, `created_by` | é”€å”®ä¸»å•ã€‚ |
| `sales_item` | `id`, `order_id`, `product_id`, `quantity`, **`snapshot_cost`**, **`snapshot_standard_price`**, **`actual_sale_price`** | **æ ¸å¿ƒ:** è®°å½•é”€å”®æ—¶çš„è¿›ä»·ã€ç³»ç»Ÿç®—å‡ºçš„æ ‡å‡†ä»·ã€å®é™…æˆäº¤ä»·ã€‚ |

## âš™ï¸ å››ã€API æ¥å£è§„åˆ’ (FastAPI)

### 1. è®¤è¯ä¸æƒé™
* `POST /api/auth/login`: ç™»å½•ï¼Œè¿”å› tokenï¼›token æºå¸¦è§’è‰²ä¿¡æ¯ã€‚
* ä¸­é—´ä»¶æŒ‰è§’è‰²è£å‰ªå“åº”å­—æ®µ (åº—å‘˜ä¸å¯çœ‹åˆ°æˆæœ¬/æ¯›åˆ©/é‡‡è´­é‡‘é¢)ã€‚

### 2. å•†å“ä¸ä»·æ ¼ç®¡ç†
* `GET /api/price/calculate/{product_id}`: åç«¯æ‰§è¡Œ 3 çº§ä»·æ ¼é€»è¾‘ï¼Œè¿”å›è¯¥å•†å“çš„å½“å‰â€œæ ‡å‡†é›¶å”®ä»·â€å’Œâ€œè®¡ç®—ä¾æ® (æ˜¯ä¾‹å¤–ã€åˆ†ç±»è¿˜æ˜¯å…¨å±€)â€ã€‚
* `POST /api/products`: å½•å…¥å•†å“ï¼Œæ”¯æŒè®¾ç½® `fixed_retail_price`ã€‚
* `PUT /api/categories/{id}`: è®¾ç½®åˆ†ç±»çš„ `retail_multiplier`ã€‚
* `POST /api/import/products`: ä¸Šä¼  CSV/Excelï¼Œå¼‚æ­¥è§£æï¼›è¿”å›å¯¼å…¥ä»»åŠ¡ IDï¼Œæä¾›é”™è¯¯æŠ¥å‘Šä¸‹è½½ã€‚
* `GET /api/import/{job_id}`: æŸ¥è¯¢å¯¼å…¥çŠ¶æ€ã€‚

### 3. é”€å”®ä¸åº“å­˜
* `POST /api/sales`: æäº¤é”€å”®å•ã€‚
    * **åç«¯å¤„ç†:** æ¥æ”¶ `product_id`, `quantity`, `actual_price`ã€‚
    * **è‡ªåŠ¨å¤„ç†:** æŸ¥è¯¢å½“å‰çš„ `base_cost` å’Œ `standard_price`ï¼Œè¿åŒå‰ç«¯ä¼ æ¥çš„ `actual_price` ä¸€èµ·å­˜å…¥ `sales_item`ã€‚
    * **åº“å­˜å¤„ç†:** æ‰£å‡ `inventory`ï¼Œæ’å…¥ `inventory_log`ã€‚
* `POST /api/inventory/adjust`: æ‰‹å·¥è°ƒæ•´åº“å­˜ (è€æ¿æƒé™)ã€‚
* `GET /api/inventory/logs`: æŸ¥è¯¢åº“å­˜å˜åŠ¨å†å²ï¼Œæ”¯æŒæŒ‰å•†å“/æ—¶é—´ç­›é€‰ã€‚

### 4. é‡‡è´­
* `POST /api/purchase-orders`: åˆ›å»ºé‡‡è´­å• (è‰ç¨¿)ã€‚
* `PUT /api/purchase-orders/{id}/receive`: åˆ°è´§ç¡®è®¤ï¼Œæ”¯æŒéƒ¨åˆ†åˆ°è´§ï¼›å…¥åº“å¹¶å†™åº“å­˜æ—¥å¿—ã€‚
* `GET /api/purchase-orders`: åˆ—è¡¨/çŠ¶æ€ç­›é€‰ã€‚

### 5. æŠ¥è¡¨åˆ†æ (Dashboard)
* `GET /api/dashboard/realtime`:
    * è¿”å›ï¼šå½“æ—¥å®é™…é”€å”®é¢ã€å½“æ—¥æ¯›åˆ©ã€è®¢å•æ•°ã€å®¢å•ä»·ã€‚
* `GET /api/dashboard/inventory_value`:
    * è¿”å›ï¼šå½“å‰åº“å­˜æ€»æˆæœ¬ã€**å½“å‰åº“å­˜æ½œåœ¨æ€»å”®ä»·** (åŸºäºå½“å‰ä»·æ ¼ä½“ç³»è®¡ç®—)ã€‚
* `GET /api/dashboard/performance`:
    * è¿”å›ï¼šæŒ‡å®šæ—¶é—´æ®µå†…çš„ **â€œé”€å”®å·®å€¼â€** (å®é™…å–å‡ºçš„é’± vs åº”è¯¥å–å‡ºçš„é’±)ï¼Œç”¨äºè¯„ä¼°é—¨åº—æ˜¯å¦å­˜åœ¨è¿‡åº¦æ‰“æŠ˜æˆ–æº¢ä»·é”€å”®æƒ…å†µã€‚
* **ç»´åº¦/å¯¹æ¯”:** æ”¯æŒæ—¥/å‘¨/æœˆ/è‡ªå®šä¹‰åŒºé—´ï¼›åŒæ¯”/ç¯æ¯”ï¼›æŒ‰åˆ†ç±»ã€å•å“ã€åº—å‘˜ç»´åº¦æ‹†è§£ï¼›è¾“å‡ºæ¯›åˆ©ç‡ã€æŠ˜æ‰£ç‡åˆ†å¸ƒã€‚åº—å‘˜è§’è‰²ä»…å±•ç¤ºé”€å”®é¢ä¸è®¢å•é‡ï¼Œä¸å±•ç¤ºæˆæœ¬/æ¯›åˆ©ã€‚

## ğŸ³ äº”ã€éƒ¨ç½²æ¶æ„ (Docker Compose / ç°æœ‰ Nginx)

ç”±äºç›®æ ‡æ˜¯ **å¾®ä¿¡å°ç¨‹åº**ï¼Œå¿…é¡»é…ç½® SSLã€‚æœåŠ¡å™¨å·²æœ‰ Nginxï¼ŒDocker Compose ä»…éœ€èµ·åç«¯ä¸æ•°æ®åº“ï¼ŒNginx ä½¿ç”¨å®¿ä¸»æœºç°æœ‰è¿›ç¨‹ã€‚

```yaml
version: '3.8'

services:
  # 1. æ•°æ®åº“
  db:
    image: postgres:18
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: fireworks_db

  # 2. åç«¯ API
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --workers 12
    environment:
      DATABASE_URL: postgresql://user:password@db/fireworks_db
    depends_on:
      - db
    ports:
      - "8000:8000"  # ä¾›å®¿ä¸»æœº Nginx åä»£
```

### éƒ¨ç½²çº¦å®š (è…¾è®¯äº‘ + å®¿ä¸»æœº Nginx)
* ç¯å¢ƒï¼šå•ç”Ÿäº§ç¯å¢ƒï¼Œæ— ç°åº¦ï¼›è‹¥éœ€é¢„å‘å¸ƒï¼Œä½¿ç”¨ç›¸åŒ compose ç»“æ„ç‹¬ç«‹ namespace/ç«¯å£ã€‚
* è¯ä¹¦ï¼šè…¾è®¯äº‘ä¸Šé€šè¿‡ acme å·²æœ‰è¯ä¹¦ï¼Œæ”¾åœ¨å®¿ä¸»æœº Nginx è¯ä¹¦è·¯å¾„ï¼›ç»­æœŸå reload Nginxã€‚
* Nginx åå‘ä»£ç†ï¼šåœ¨å®¿ä¸»æœº Nginx `conf.d` æ–°å¢ç«™ç‚¹ï¼Œåä»£åˆ° `http://127.0.0.1:8000`ï¼Œå¼€å¯ HTTPSã€å¼ºåˆ¶ 301 è·³è½¬ï¼Œé™åˆ¶åç«¯ä»…å†…ç½‘å¯è®¿é—®ã€‚
* å°ç¨‹åºåˆè§„ï¼šä»…æš´éœ² HTTPS åŸŸåï¼Œåç«¯ä¸ç›´æ¥æš´éœ²å…¬ç½‘ç«¯å£ï¼ˆå¦‚éœ€æ’éšœï¼Œå¯ä¸´æ—¶å¼€æ”¾å®‰å…¨ç»„å¹¶åŠæ—¶å…³é—­ï¼‰ã€‚
