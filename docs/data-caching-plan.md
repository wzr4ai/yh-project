# 数据访问优化方案（ETag/版本戳 + 乐观并发）

目标：减少商品/分类/库存等数据的交互延迟与带宽占用，同时保持一致性，兼容现有 FastAPI + UniApp 代码。

## 现状概述
- 主要列表：商品列表 `/api/products`（带分页/筛选/搜索）、分类 `/api/categories`、库存概览 `/api/inventory/overview`。
- 写操作：商品更新/创建、库存调整、销售创建等，当前无版本校验。
- 痛点：频繁进入列表/详情会重复全量拉取；弱网时延迟明显。

## 总体方案
1) **为只读接口增加 ETag/版本戳**  
   - 后端为响应计算 `etag`（建议哈希：接口路径 + 查询参数 + 数据更新时间戳/row max updated_at）。  
   - 前端每次请求带上 `If-None-Match`，后端未变化返回 304（空体），前端复用本地缓存。
   - 版本戳粒度：按接口+参数维度（例：`/api/products?offset=0&limit=20&keyword=...`）。

2) **乐观并发控制写接口**  
   - 在商品更新、分类更新、库存调整等写接口中，接受可选 `If-Match` 头或 `version` 字段。  
   - 后端比对当前版本戳，不匹配时返回 409/412，让前端提示“数据已更新，刷新后重试”。
   - 版本来源：同一资源的最新 `etag` 或行级 `updated_at`。

3) **前端缓存策略**  
   - UniApp 侧为商品/分类/库存列表维护本地缓存（`uni.setStorageSync`），记录 `etag` + 数据。  
   - 请求时先带 `If-None-Match`，304 则直接用缓存；200 则更新缓存与 `etag`。  
   - 对高频刷新页面（商品列表）保持分页缓存（仅缓存当前页与上一次页码）。

4) **增量/推送（可选）**  
   - 后端预留“自某时间戳后的更新”增量接口；或使用 WebSocket 推送最新版本戳，前端收到后清除缓存/轻量校验。

## 后端改动计划
1. **ETag 支持**  
   - 在 FastAPI 层封装中间件/工具：给响应设置 `ETag`，并处理 `If-None-Match` 直接返回 304。  
   - 商品列表 `/api/products`：基于查询参数与 max(updated_at, created_at) 计算哈希。  
   - 分类 `/api/categories` 与库存概览 `/api/inventory/overview` 类似。
2. **数据模型补充时间戳**（若缺失）  
   - `product`, `category`, `inventory` 等表增加 `updated_at`（触发 on update），便于计算版本戳。  
   - 同步修改 Pydantic schema（可选）。
3. **乐观并发**  
   - 商品更新/分类更新接口读取 `If-Match` / `version`，校验当前 `etag`/`updated_at`；不匹配返回 412。  
   - 前端提交时带上上次读取的版本。

4. **脚本/迁移**  
   - 在 `schema_migrate.py` 中新增 `updated_at` 列（若缺失），并为现有数据回填（当前时间）。
   - 确保新增 `ETag` 计算函数使用上述列。

## 前端改动计划
1. **缓存存取层**  
   - 在 `common/api.js` 包装请求：处理 304 时返回缓存内容；200 时缓存响应与 `etag`（存储键包含 URL + 查询字符串）。  
   - 缓存持久化至 `uni.setStorageSync`，带过期时间（例如 10 分钟）防止冷数据沉积。
2. **版本携带写入**  
   - 商品详情/分类编辑页面在加载时保存 `etag`/`updated_at`，提交更新时在请求头或 body 中附带。  
   - 接收到 412/409 时提示用户刷新页面再编辑。
3. **页面级优化**  
   - 商品列表：首次加载缓存当前页，如 304 则直接渲染；切换页码时缓存最近页。  
   - 库存总览/分类列表类似。

## 风险与回滚
- 需要新增/更新数据库列（`updated_at`），需运行迁移脚本；若回滚，可关闭 ETag 检查（忽略 `If-None-Match`），保留原有行为。  
- ETag 计算依赖更新时间，需确保写操作后更新 `updated_at`（或触发器/手动赋值）。  
- 乐观锁可能导致少量 412 错误，需要前端友好提示。

## 验收要点
- 未改动数据时，前端重复进入列表可命中 304，不再重复传输列表数据。  
- 并发编辑同一商品时，后保存者若基于过期版本会收到 412，并被要求刷新。  
- 数据变更后，版本戳更新，前端自动拉取最新数据。  

## 后续可选
- WebSocket 推送版本戳，触发前端局部刷新。  
- 增量同步接口（按更新时间戳拉取变更集）。  
- 更精细的缓存淘汰策略（LRU/按页面频率）。
